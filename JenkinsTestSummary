pipeline {
    agent any
    
    stages {
        stage('POST API Call') {
            steps {
                script {
                    def apiUrl = 'https://venkata7.service-now.com/api/sn_devops/v1/devops/tool/test?toolId=4d8e12a9c375c250c95605bdc0013114&testType=UnitTest'
                    def requestBody = [
                        name: "User Acceptance tests",
                        duration: 0.0,
                        passedTests: 1,
                        failedTests: 1,
                        skippedTests: 1,
                        blockedTests: 1,
                        totalTests: 4,
                        startTime: "2023-12-14T23:31:31z",
	                    finishTime: "2023-12-15T23:31:31z",
                        buildNumber: env.BUILD_NUMBER,
			testType: "Unit",
                        stageName: "POST API Call",
                        pipelineName: "Venkata Pipeline"
                    ]
                    
                    def auth = "ZGV2b3BzLmludGVncmF0aW9uLnVzZXI6VGVzdGluZzEh" // devops.integration.user:<password> in base64 encoded.
                    def authHeader = "Basic " + auth
                    
                    def response = httpRequest(
                        contentType: 'APPLICATION_JSON',
                        httpMode: 'POST',
                        requestBody: groovy.json.JsonOutput.toJson(requestBody),
                        url: apiUrl,
                        customHeaders: [[name: 'Authorization', value: authHeader]]
                    )
                    
                    if (response.status == 200 || response.status == 201) {
                        echo "API call successful!"
                        echo "Response: ${response.content}"
                    } else {
                        error "API call failed with status ${response.status}"
                    }
                }
            }
        }
        stage('UAT deploy') {
                    steps {
                        script {
                            def chg_output = snDevOpsChange()
                            def changeRequestNumber = snDevOpsGetChangeNumber(changeDetails: """{"build_number":"${env.BUILD_NUMBER}", "pipeline_name": "Venkata Pipeline", "stage_name": "UAT deploy"}""")
                            echo "${changeRequestNumber}"
                            echo "Output of snDevOpsChange(): ${chg_output}"
                    }
                }
        }
        stage('Example') {
            steps {
                script {
                    def API_URL = 'https://venkata7.service-now.com/api/sn_devops/devops/orchestration/changeInfo?pipelineName=Venkata%20Pipeline&toolId=4d8e12a9c375c250c95605bdc0013114&buildNumber=' + env.BUILD_NUMBER + '&stageName=UAT%20deploy'
                    def AUTH = 'Basic ZGV2b3BzLmludGVncmF0aW9uLnVzZXI6VGVzdGluZzEh'
                    // Call the API
                    def response = sh(script: "curl -X GET -H 'Authorization: ${AUTH}' -H 'Content-Type: application/json' '${API_URL}'", returnStdout: true).trim()
                    echo "Response: ${response}"
                    
                    // Store the JSON response into a variable
                    def slurper = new groovy.json.JsonSlurper()
                    def jsonResponse = slurper.parseText(response)
                    echo "Stored JSON Response: ${jsonResponse}"
                    
                    // Store the specific field value from JSON response into a variable
                    def changeId = jsonResponse.result.sys_id
                    echo "Change ID: ${changeId}"
                    
                    // Call the second API to post attachment
                    def xmlData = '<xml>
<sys_user>
<accumulated_roles/>
<active>true</active>
<avatar/>
<building/>
<calendar_integration>1</calendar_integration>
<city/>
<company/>
<cost_center/>
<country/>
<date_format/>
<default_perspective/>
<department/>
<edu_status>faculty</edu_status>
<email/>
<employee_number/>
<enable_multifactor_authn>false</enable_multifactor_authn>
<failed_attempts>0</failed_attempts>
<federated_id/>
<first_name>DevOps</first_name>
<gender/>
<hashed_user_id>d0d1de80fad3b49b4c7f20787be9c63706387ddc6419e14eba6f8ba572348643</hashed_user_id>
<home_phone/>
<internal_integration_user>false</internal_integration_user>
<introduction/>
<last_login/>
<last_login_device/>
<last_login_time/>
<last_name>System</last_name>
<last_password/>
<ldap_server/>
<location/>
<locked_out>false</locked_out>
<manager/>
<middle_name/>
<mobile_phone/>
<name>DevOps System</name>
<notification>2</notification>
<password_needs_reset>false</password_needs_reset>
<phone/>
<photo/>
<preferred_language/>
<roles/>
<schedule/>
<source/>
<state/>
<street/>
<sys_class_name>sys_user</sys_class_name>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2019-02-14 22:36:25</sys_created_on>
<sys_domain>global</sys_domain>
<sys_domain_path>/</sys_domain_path>
<sys_id>a0e11bb23ba32300b200655593efc491</sys_id>
<sys_mod_count>3</sys_mod_count>
<sys_updated_by>guest</sys_updated_by>
<sys_updated_on>2024-04-26 10:53:02</sys_updated_on>
<time_format/>
<time_zone/>
<title/>
<user_name>devops.system</user_name>
<user_password>$s$qkq97jBJTtjNmP8W/zmIZdgx8T4onTq1T73Wu/7fN/k=$40AOqSW0SZZVgLonVsguGlJeSnUba9TrPwmFI+bWUoQ=</user_password>
<vip>false</vip>
<web_service_access_only>false</web_service_access_only>
<zip/>
</sys_user>
</xml>'
                    def AUTH2 = 'Basic YWJlbC50dXRlcjpUZXN0aW5nMSE='
                    sh(script: "curl -X POST -H 'Authorization: ${AUTH2}' -H 'Content-Type: application/xml' -d '${xmlData}' 'https://venkata7.service-now.com/api/now/attachment/file?table_name=change_request&table_sys_id=${changeId}&file_name=test10111.xml'", returnStdout: true).trim()
                }
            }
        }
    }
}
